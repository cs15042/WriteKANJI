<!DOCTYPE html>
<html oncontextmenu="return false">
<head>
  <meta charset="utf-8">
  <meta name="author" content="cs15042">
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="漢字を書こう！">
  <title>漢字を書こう！</title>
  <link rel="icon" href="kanji.ico" />
  <link rel="stylesheet" href="style.css">
  <script src="../../jquery-3.2.1.min.js"></script>
  <script src="../../blockly_compressed.js"></script>
  <script src="../../blocks_compressed.js"></script>
  <script src="../../javascript_compressed.js"></script>
  <script src="../../msg/js/ja.js"></script>
  
  <script src="../../blocks/kanji3/drawLine_block.js"></script>
  <script src="../../generators/javascript/kanji3/drawLine.js"></script>

  <script src="../../blocks/kanji3/fromTo_block.js"></script>
  <script src="../../generators/javascript/kanji3/fromTo.js"></script>

  <script src="../../blocks/kanji3/coordinate_block.js"></script>
  <script src="../../generators/javascript/kanji3/coordinate.js"></script>

  <script src="../../blocks/kanji3/mod_block.js"></script>
  <script src="../../generators/javascript/kanji3/mod.js"></script>

  <script src="../../blocks/kanji3/stroked_block.js"></script>
  <script src="../../generators/javascript/kanji3/stroked.js"></script> 

  <script src="../../blocks/kanji3/canvas_block.js"></script>
  <script src="../../generators/javascript/kanji3/canvas.js"></script>

  <script src="../../blocks/kanji3/relation_block.js"></script>
  <script src="../../generators/javascript/kanji3/relation.js"></script>  

  <script src="../../blocks/kanji3/at_block.js"></script>
  <script src="../../generators/javascript/kanji3/at.js"></script>

  <script src="../../blocks/kanji3/compare_block.js"></script>
  <script src="../../generators/javascript/kanji3/compare.js"></script>

  <script src="../../blocks/kanji3/sameLength_block.js"></script>
  <script src="../../generators/javascript/kanji3/sameLength.js"></script>  

  <script src="../../blocks/kanji3/through_block.js"></script>
  <script src="../../generators/javascript/kanji3/through.js"></script>  
</head>


<body>
 <div class="relative" id ="main">
  <!--<h1>漢字を書こう</h1>-->
 <a id="save" href="#" download="WKsav.xml" onclick="save()">ブロックを保存</a>
  <div class="originalFileBtn">
    ファイルから展開
    <input id="load" type="file" accept="text/xml">
  </div>
  <br><br>
  <table>
    <tr>
      <td>
        <div id="blocklyDiv" style="height: 800px; width: 1400px;"></div>
        <xml id="toolbox" style="display: none">
		  
		  <category name="動作">
            <block type="drawLine"></block>
          </category>

          <category name="場所">
            <block type="canvas"></block>
            <block type="stroked"></block>
            <block type="coordinate"></block>
            <block type="relation"></block>
            <block type="mod"></block>
          </category>

          <category name="制約">
            <block type="at"></block>
            <block type="through"></block>
            <block type="fromTo"></block>
          </category>

          <category name="線の長さ">
            <block type="compare"></block>
            <block type="sameLength"></block>
          </category>

        </xml>
      </td>
      <td>&nbsp;&nbsp;</td>
      <td>
    	<center>
    		<a href="#" id="btn-flat-border" onclick="runCode()">実行</a>
    		<br><br>
        	<canvas id="canvas" width="400px" height="400px">
          		図形を表示するには、canvasタグをサポートしたブラウザが必要です。
        	</canvas>
        	<br>
        	<a href="#" id="btn-flat-border" onclick="clearCanvas()">白紙に戻す</a>
        </center>
      </td>
    </tr>
  </table>
 </div>
  <!--<p>生成されたソースコード</p>
  <p id="program" />
  -->
  <script>
  	var toolbox = document.getElementById("toolbox");
	var options = { 
		toolbox : toolbox, 
		collapse : true, 
		comments : false, 
		disable : false, 
		maxBlocks : Infinity, 
		trashcan : true, 
		horizontalLayout : false, 
		toolboxPosition : 'start', 
		css : true, 
		media : '../../media/', 
		rtl : false, 
		scrollbars : true, 
		sounds : true, 
		oneBasedIndex : true, 
		zoom : {
			controls : true, 
			wheel : false, 
			startScale : 1, 
			maxScale : 3, 
			minScale : 0.3, 
			scaleSpeed : 1.2
		}
	};
    var workspace = Blockly.inject('blocklyDiv', options);

    var rootElement = document.documentElement;
	rootElement.requestFullscreen = rootElement.requestFullscreen || rootElement.mozRequestFullScreen || rootElement.webkitRequestFullscreen || rootElement.msRequestFullscreen;
	document.exitFullscreen = document.exitFullscreen || document.cancelFullScreen || document.mozCancelFullScreen || document.webkitCancelFullScreen || document.msExitFullscreen;


    var count = 1;
    var coordinateLog = new Array(50);
    for(var j = 0; j < 50; j++) {
      coordinateLog[j] = new Array(4);
      for(var i = 0; i < 4; i++) {
        coordinateLog[j][i] = "-1";
      }
    }

    var run = false;

    var canvas = document.getElementById('canvas');
    var context = canvas.getContext('2d');
    context.fillStyle = 'rgb(255,255,255)';
    context.fillRect(0,0,400,400);

    var obj1 = document.getElementById("load");
    obj1.addEventListener("change",function(evt){
      var file = evt.target.files;
      var reader = new FileReader();
      reader.readAsText(file[0]);
      reader.onload = function(ev){
        xmlText = reader.result;
        try{
          xmlDom = Blockly.Xml.textToDom(xmlText);
        }catch(e){
        }
        if(xmlDom){
          workspace.clear();
          Blockly.Xml.domToWorkspace(xmlDom, workspace);
        }
      }
    },false);

    function init(){
      for(var j = 0; j < 50; j++) {
        for(var i = 0; i < 4; i++) {
          coordinateLog[j][i] = "-1";
        }
      }
      count = 1;
      clearCanvas();
    }
    
    function showCode(){
      // Generate JavaScript code and display it.
      init();
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      if (code == ""){
        alert("ブロックがありません");
      }else{
        //document.getElementById("program").innerHTML = code;
        eval(code);
	      alert(code);
      }
    }

    function runCode(){
      // Generate JavaScript code and run it.
      //showCode();
      init();
      window.LoopTrap = 1000;
      Blockly.JavaScript.INFINITE_LOOP_TRAP =
          'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      run = true;
      try{
        eval(code);
      }catch(e){
        alert("エラーです.\n(" + e + ")");
      }
      run = false;
    } 

    function drawLine(fromX,fromY,toX,toY){
      if(run == false){
        log(fromX,fromY,toX,toY);
      	return;
      }
      if (arguments.length !== 4){
        alert("[IllegalArgument:引数不正]エラーです.");
      }
      
      context.beginPath();
      context.moveTo(fromX,fromY);
      context.lineTo(toX,toY);
      context.stroke();
    }

    function log(fromX,fromY,toX,toY){
      coordinateLog[count][0] = fromX;
      coordinateLog[count][1] = fromY;
      coordinateLog[count][2] = toX;
      coordinateLog[count][3] = toY;
      console.log("stroke" + count + ": " + coordinateLog[count]);
      count++;
    }

    function clearCanvas(){
      context.fillRect(0,0,400,400);
      console.log("--clear canvas--");
    }

    function sleep(msec){
      return new Promise(function(resolve){
        setTimeout(function() {resolve()}, msec);
     });
    }

    function save(){
      var xmlDom = Blockly.Xml.workspaceToDom(workspace);
      var xmlText = Blockly.Xml.domToPrettyText(xmlDom);
      var blob = new Blob([xmlText], { "type" : "text/xml" });
      if(window.navigator.msSaveBlob){ 
        window.navigator.msSaveBlob(blob, "WKsav.xml");  
      }else{
        document.getElementById("save").href = window.URL.createObjectURL(blob);
      }
    }
  </script>
</body>
</html>
