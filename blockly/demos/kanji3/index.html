<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>漢字を書こう！</title>
  <link rel="icon" href="kanji.ico" />
  <script src="../../jquery-3.2.1.min.js"></script>
  <script src="../../blockly_compressed.js"></script>
  <script src="../../blocks_compressed.js"></script>
  <script src="../../javascript_compressed.js"></script>
  <script src="../../msg/js/ja.js"></script>
  
  <script src="../../blocks/kanji3/drawLine_block.js"></script>
  <script src="../../generators/javascript/kanji3/drawLine.js"></script>

  <script src="../../blocks/kanji3/fromTo_block.js"></script>
  <script src="../../generators/javascript/kanji3/fromTo.js"></script>

  <script src="../../blocks/kanji3/coordinate_block.js"></script>
  <script src="../../generators/javascript/kanji3/coordinate.js"></script>

  <script src="../../blocks/kanji3/mod_block.js"></script>
  <script src="../../generators/javascript/kanji3/mod.js"></script>

  <script src="../../blocks/kanji3/stroked_block.js"></script>
  <script src="../../generators/javascript/kanji3/stroked.js"></script> 

  <script src="../../blocks/kanji3/canvas_block.js"></script>
  <script src="../../generators/javascript/kanji3/canvas.js"></script>

  <script src="../../blocks/kanji3/relation_block.js"></script>
  <script src="../../generators/javascript/kanji3/relation.js"></script>  

  <script src="../../blocks/kanji3/at_block.js"></script>
  <script src="../../generators/javascript/kanji3/at.js"></script>

  <script src="../../blocks/kanji3/compare_block.js"></script>
  <script src="../../generators/javascript/kanji3/compare.js"></script>

  <script src="../../blocks/kanji3/sameLength_block.js"></script>
  <script src="../../generators/javascript/kanji3/sameLength.js"></script>  

  <script src="../../blocks/kanji3/through_block.js"></script>
  <script src="../../generators/javascript/kanji3/through.js"></script>  


  <style>
    body{
      background-color: #fff;
      font-family: sans-serif;
    }
    h1{
      font-weight: normal;
      font-size: 150%;
    }
    canvas{
      border: 1px solid silver;
    }
    .relative{
		position: relative;
	}
	.relative:before{
		content:'';
		display:block;
	}
    #btn-square-so-pop{
	  position: relative;
	  display: inline-block;
	  padding: 0.25em 0.5em;
	  text-decoration: none;
	  color: #FFF;
	  background: #fd9535;/*色*/
	  border-radius: 4px;/*角の丸み*/
	  box-shadow: inset 0 2px 0 rgba(255,255,255,0.2), inset 0 -2px 0 rgba(0, 0, 0, 0.05);
	  font-weight: bold;
	  border: solid 2px #d27d00;/*線色*/
	  font-size: 20px;
	}
	#btn-square-so-pop:active{
	  /*押したとき*/
	  box-shadow: 0 0 2px rgba(0, 0, 0, 0.30);
	}
  </style>
</head>
<body>
 <div class="relative" id ="main">
  <!--<h1>漢字を書こう</h1>-->
  <table>
    <tr>
      <td>
        <div id="blocklyDiv" style="height: 700px; width: 1100px;"></div>

        <xml id="toolbox" style="display: none">


          <category name="場所">
            <block type="canvas"></block>
            <block type="stroked"></block>
            <block type="coordinate"></block>
            <block type="relation"></block>
            <block type="mod"></block>
          </category>

          <category name="助詞">
            <block type="at"></block>
            <block type="through"></block>
            <block type="fromTo"></block>
          </category>

          <category name="線の長さ">
            <block type="compare"></block>
            <block type="sameLength"></block>
          </category>

          <category name="動詞">
            <block type="drawLine"></block>
          </category>


        </xml>
      </td>
      <td>&nbsp;&nbsp;</td>
      <td>
    	<center>
    		<a href="#" id="btn-square-so-pop" onclick="runCode()">実行</a>
    		<br><br>
        	<canvas id="canvas" width="400px" height="400px">
          		図形を表示するには、canvasタグをサポートしたブラウザが必要です。
        	</canvas>
        	<br>
        	<a href="#" id="btn-square-so-pop" onclick="clearCanvas()">白紙に戻す</a>
        </center>
      </td>
    </tr>
  </table>

  <!--<p>生成されたソースコード</p>
  <p id="program" />
  -->
  <script>
    var demoWorkspace = Blockly.inject('blocklyDiv',{media: '../../media/',toolbox: document.getElementById('toolbox')});

    var rootElement = document.documentElement;
	rootElement.requestFullscreen = rootElement.requestFullscreen || rootElement.mozRequestFullScreen || rootElement.webkitRequestFullscreen || rootElement.msRequestFullscreen;
	document.exitFullscreen = document.exitFullscreen || document.cancelFullScreen || document.mozCancelFullScreen || document.webkitCancelFullScreen || document.msExitFullscreen;


    var count = 1;
    var coordinateLog = new Array(50);
    for(var j = 0; j < 50; j++) {
      coordinateLog[j] = new Array(4);
      for(var i = 0; i < 4; i++) {
        coordinateLog[j][i] = "-1";
      }
    }

    var run = false;

    function init(){
      for(var j = 0; j < 50; j++) {
        for(var i = 0; i < 4; i++) {
          coordinateLog[j][i] = "-1";
        }
      }
      count = 1;
      clearCanvas();
    }
    
    function showCode(){
      // Generate JavaScript code and display it.
      init();
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
      if (code == ""){
        alert("ブロックがありません");
      }else{
        //document.getElementById("program").innerHTML = code;
        eval(code);
	      alert(code);
      }
    }

    function runCode(){
      // Generate JavaScript code and run it.
      //showCode();
      init();
      window.LoopTrap = 1000;
      Blockly.JavaScript.INFINITE_LOOP_TRAP =
          'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
      var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      run = true;
      try{
        eval(code);
      }catch(e){
        alert("エラーです.\n(" + e + ")");
      }
      run = false;
    } 

    function drawLine(fromX,fromY,toX,toY){
      if(run == false){
        log(fromX,fromY,toX,toY);
      	return;
      }
      if (arguments.length !== 4){
        alert("[IllegalArgument:引数不正]エラーです.");
      }

      var canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');
      
      context.beginPath();
      context.moveTo(fromX,fromY);
      context.lineTo(toX,toY);
      context.stroke();
    }

    function log(fromX,fromY,toX,toY){
      coordinateLog[count][0] = fromX;
      coordinateLog[count][1] = fromY;
      coordinateLog[count][2] = toX;
      coordinateLog[count][3] = toY;
      console.log(count + ": " + coordinateLog[count]);
      count++;
    }

    function clearCanvas(){
      var canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');

      context.clearRect(0,0,400,400);
      console.log("--clear canvas--");
    }

    function sleep(msec){
      return new Promise(function(resolve){
        setTimeout(function() {resolve()}, msec);
     });
    }
    
  </script>
 </div>
</body>
</html>
